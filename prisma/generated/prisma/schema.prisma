// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED") // For migrations (bypasses connection pooling)
}

// =====================
// AUTHENTICATION MODELS
// =====================

enum Role {
  ADMIN
  OWNER
  TEACHER
  FAMILY
  CASA_RURAL
  EMPLEADO
  GUEST
}

model User {
  id           String  @id @default(cuid())
  email        String  @unique
  passwordHash String? // null if using OAuth
  name         String?
  image        String?
  role         Role    @default(GUEST)

  // Per-module access overrides
  canAccessCasaRural     Boolean @default(false)
  canAccessFinanzas      Boolean @default(false)
  canAccessFpInformatica Boolean @default(false)
  canAccessHogar         Boolean @default(false)
  canAccessMasterUnie    Boolean @default(false)

  sessions           Session[]
  accounts           Account[]
  activities         EmployeeActivity[]
  assets             Asset[]
  portfolioSnapshots PortfolioSnapshot[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

// Areas / Categories (The 4 main pillars)
model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  slug        String  @unique
  description String?
  color       String? // Hex code for UI representation
  icon        String? // Icon name (e.g. Lucide icon name)

  items    ActionItem[]
  sections TaskSection[]
  sessions ClassSession[]
  projects Project[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Task Sections for organizing tasks within a category
model TaskSection {
  id    String @id @default(cuid())
  name  String
  order Int    @default(0) // For ordering sections

  // Relations
  categoryId String
  category   Category     @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  items      ActionItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// General Task / Action Item
model ActionItem {
  id          String  @id @default(cuid())
  title       String
  description String?

  // Status: TODO, IN_PROGRESS, DONE, ARCHIVED
  status String @default("TODO")

  // Priority: LOW, MEDIUM, HIGH, URGENT
  priority String @default("MEDIUM")

  dueDate DateTime?

  isCompleted Boolean @default(false) // Helper for quick check

  // Relations
  categoryId String
  category   Category     @relation(fields: [categoryId], references: [id])
  sectionId  String?
  section    TaskSection? @relation(fields: [sectionId], references: [id], onDelete: SetNull)
  subjectId  String?
  subject    Subject?     @relation(fields: [subjectId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Teacher Module: Class Sessions / Calendar Events
model ClassSession {
  id          String   @id @default(cuid())
  title       String
  description String?
  date        DateTime // The day of the class
  startTime   String? // e.g. "08:30"
  endTime     String? // e.g. "09:20"

  // Relations
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Teacher Module: Project Management
model Project {
  id          String  @id @default(cuid())
  title       String
  description String?

  status String @default("PLANNING") // PLANNING, IN_PROGRESS, COMPLETED

  images ProjectImage[]

  // Relations
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProjectImage {
  id  String @id @default(cuid())
  url String // /uploads/filename.jpg

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  createdAt DateTime @default(now())
}

// Master UNIE Module
model Subject {
  id        String  @id @default(cuid())
  name      String
  code      String? // e.g. "MU-01"
  professor String?
  credits   Float   @default(6.0) // ECTS
  semester  Int     @default(1)

  // Status: ENROLLED, IN_PROGRESS, PASSED, FAILED
  status String @default("ENROLLED")

  // Grades
  finalGrade Float? // 0-10

  // Relations
  assessments Assessment[]
  tasks       ActionItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Assessment {
  id     String @id @default(cuid())
  title  String // e.g. "Examen Final", "Pr√°ctica 1"
  weight Float // Percentage 0-100
  grade  Float? // 0-10

  // Relations
  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Casa Rural: Employee Activity Log
model EmployeeActivity {
  id          String   @id @default(cuid())
  title       String
  description String?
  category    String // limpieza, mantenimiento, compras, incidencia, otro
  date        DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Exam Generator Templates
model ExamTemplate {
  id   String @id @default(cuid())
  name String

  // Header Data
  logoUrl         String?
  cycle           String?
  course          String?
  evaluation      String?
  duration        String?
  date            String?
  subject         String?
  raEvaluated     String? // Stored as JSON string or comma separated
  description     String? // Header description/instructions
  part1Percentage String?
  part2Percentage String?

  // Dynamic Content
  sections String // JSON string: Array of { type, title, content, ... }

  // Formatting
  formatting String // JSON string: { font, size, spacing, ... }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =====================
// FINANCIAL MODELS
// =====================

// =====================
// FINANCIAL MODELS
// =====================

model Asset {
  id       String  @id @default(cuid())
  ticker   String?
  name     String
  category String  @default("GENERAL") // Added default to fix migration
  platform String?

  quantity  Float   @default(0.0)
  price_eur Float   @default(0.0)
  currency  String?

  // Flags
  yahoo_symbol String?
  coingecko_id String?
  coincap_id   String?
  indexa_api   Boolean @default(false)
  manual       Boolean @default(false)

  // UI
  image_url String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  history HistoricalPrice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("assets")
}

model HistoricalPrice {
  id        String   @id @default(cuid())
  price_eur Float    @default(0.0) // Added default to fix migration
  date      DateTime

  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([assetId])
  @@index([date])
  @@map("historical_prices")
}

model PortfolioSnapshot {
  id              String   @id @default(cuid())
  total_value_eur Float    @default(0.0) // Added default to fix migration
  date            DateTime
  category        String?
  asset_id        String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([date])
  @@index([userId])
  @@map("portfolio_snapshots")
}
