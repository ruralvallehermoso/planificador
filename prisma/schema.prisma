generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters", "multiSchema"]
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
  schemas   = ["casarural", "public"]
}

model User {
  id                     String              @id @default(cuid())
  email                  String              @unique
  passwordHash           String?
  name                   String?
  image                  String?
  role                   Role                @default(GUEST)
  canAccessCasaRural     Boolean             @default(false)
  canAccessFinanzas      Boolean             @default(false)
  canAccessFpInformatica Boolean             @default(false)
  canAccessHogar         Boolean             @default(false)
  canAccessMasterUnie    Boolean             @default(false)
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  accounts               Account[]
  activities             EmployeeActivity[]
  internship             Internship?
  masterTasks            MasterTask[]
  sessions               Session[]
  assets                 Asset[]
  portfolioSnapshots     PortfolioSnapshot[]

  @@schema("public")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("public")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@schema("public")
}

model Category {
  id          String         @id @default(cuid())
  name        String         @unique
  slug        String         @unique
  description String?
  color       String?
  icon        String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  items       ActionItem[]
  sessions    ClassSession[]
  projects    Project[]
  subjects    Subject[]
  sections    TaskSection[]

  @@schema("public")
}

model TaskSection {
  id         String       @id @default(cuid())
  name       String
  order      Int          @default(0)
  categoryId String
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  items      ActionItem[]
  category   Category     @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@schema("public")
}

model ActionItem {
  id          String       @id @default(cuid())
  title       String
  description String?
  status      String       @default("TODO")
  priority    String       @default("MEDIUM")
  dueDate     DateTime?
  isCompleted Boolean      @default(false)
  categoryId  String
  sectionId   String?
  subjectId   String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  category    Category     @relation(fields: [categoryId], references: [id])
  section     TaskSection? @relation(fields: [sectionId], references: [id])
  subject     Subject?     @relation(fields: [subjectId], references: [id])

  @@schema("public")
}

model ClassSession {
  id          String   @id @default(cuid())
  title       String
  description String?
  date        DateTime
  startTime   String?
  endTime     String?
  content     String?   @db.Text
  driveLink   String?
  categoryId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  category    Category @relation(fields: [categoryId], references: [id])

  @@schema("public")
}

model Project {
  id          String         @id @default(cuid())
  title       String
  description String?
  status      String         @default("PLANNING")
  categoryId  String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  category    Category       @relation(fields: [categoryId], references: [id])
  images      ProjectImage[]
  links       ProjectLink[]

  @@schema("public")
}

model ProjectImage {
  id        String   @id @default(cuid())
  url       String
  projectId String
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@schema("public")
}

model ProjectLink {
  id        String   @id @default(cuid())
  url       String
  title     String?
  projectId String
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@schema("public")
}

model Subject {
  id          String       @id @default(cuid())
  name        String
  code        String?
  professor   String?
  credits     Float        @default(6.0)
  semester    Int          @default(1)
  status      String       @default("ENROLLED")
  finalGrade  Float?
  categoryId  String?
  category    Category?    @relation(fields: [categoryId], references: [id])
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  tasks       ActionItem[]
  assessments Assessment[]

  @@schema("public")
}

model Assessment {
  id        String   @id @default(cuid())
  title     String
  weight    Float
  grade     Float?
  subjectId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@schema("public")
}

model EmployeeActivity {
  id          String   @id @default(cuid())
  title       String
  description String?
  category    String
  date        DateTime @default(now())
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("public")
}

model ExamTemplate {
  id              String   @id @default(cuid())
  name            String
  logoUrl         String?
  cycle           String?
  course          String?
  evaluation      String?
  duration        String?
  date            String?
  subject         String?
  raEvaluated     String?
  description     String?
  part1Percentage String?
  part2Percentage String?
  sections        String
  formatting      String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@schema("public")
}

model Asset {
  id           String   @id @default(cuid()) @db.VarChar
  name         String   @db.VarChar
  ticker       String?  @db.VarChar
  category     String   @db.VarChar
  platform     String?  @db.VarChar
  quantity     Float
  price_eur    Float
  currency     String?  @db.VarChar
  yahoo_symbol String?  @db.VarChar
  coingecko_id String?  @db.VarChar
  coincap_id   String?  @db.VarChar
  indexa_api   Boolean?
  manual       Boolean?
  image_url    String?  @db.VarChar
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([id], map: "ix_assets_id")
  @@map("assets")
  @@schema("public")
}

model HistoricalPrice {
  id        Int      @id @default(autoincrement())
  assetId   String   @map("asset_id") @db.VarChar
  date      DateTime @db.Date
  price_eur Float

  @@index([assetId], map: "ix_historical_prices_asset_id")
  @@index([date], map: "ix_historical_prices_date")
  @@index([id], map: "ix_historical_prices_id")
  @@map("historical_prices")
  @@schema("public")
}

model PortfolioSnapshot {
  id              Int      @id @default(autoincrement())
  date            DateTime @db.Date
  category        String?  @db.VarChar
  asset_id        String?  @db.VarChar
  total_value_eur Float
  userId          String?
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([asset_id], map: "ix_portfolio_snapshots_asset_id")
  @@index([category], map: "ix_portfolio_snapshots_category")
  @@index([date], map: "ix_portfolio_snapshots_date")
  @@index([id], map: "ix_portfolio_snapshots_id")
  @@map("portfolio_snapshots")
  @@schema("public")
}

model Internship {
  id            String            @id @default(cuid())
  userId        String            @unique
  status        String            @default("ASSIGNED")
  startDate     DateTime?
  endDate       DateTime?
  realStartDate DateTime?
  realEndDate   DateTime?
  totalHours    Int               @default(120)
  schedule      String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  workingDays   String            @default("1,2,3,4,5")
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  center        InternshipCenter?
  logs          InternshipLog[]

  @@schema("public")
}

model InternshipCenter {
  id              String     @id @default(cuid())
  name            String
  address         String?
  province        String?
  city            String?
  tutorName       String?
  tutorEmail      String?
  tutorPhone      String?
  universityTutor String?
  internshipId    String     @unique
  internship      Internship @relation(fields: [internshipId], references: [id], onDelete: Cascade)

  @@schema("public")
}

model InternshipLog {
  id           String     @id @default(cuid())
  date         DateTime
  hours        Float
  activity     String
  observations String?
  internshipId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  internship   Internship @relation(fields: [internshipId], references: [id], onDelete: Cascade)

  @@index([internshipId])
  @@schema("public")
}

model MasterTask {
  id        String   @id @default(cuid())
  title     String
  completed Boolean  @default(false)
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@schema("public")
}

model WebhookLog {
  id        String   @id @default(cuid())
  provider  String   @default("cloudmailin")
  payload   Json?
  createdAt DateTime @default(now())

  @@schema("public")
}

model Expense {
  id             Int      @id @default(autoincrement())
  date           DateTime
  amount         Decimal
  type           String
  category       String
  description    String?
  applicableYear Int?
  createdAt      DateTime @default(now())

  @@schema("casarural")
}

model BusinessConfig {
  id         Int      @id @default(autoincrement())
  name       String
  nif        String
  address    String
  phone      String
  email      String
  vatRate    Decimal  @default(10)
  city       String?
  postalCode String?
  logo       String?
  updatedAt  DateTime

  @@schema("casarural")
}

model Employee {
  id           Int       @id @default(autoincrement())
  name         String
  surname      String
  dni          String    @unique
  nss          String?
  address      String?
  phone        String?
  email        String?
  position     String?
  grossSalary  Decimal
  payments     Int       @default(12)
  startDate    DateTime
  endDate      DateTime?
  contractType String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  Leave        Leave[]
  Payslip      Payslip[]

  @@schema("casarural")
}

model Guest {
  id               Int        @id @default(autoincrement())
  name             String
  surname          String
  surname2         String?
  dni              String
  documentType     String     @default("D")
  documentSupport  String?
  address          String?
  addressExtra     String?
  postalCode       String?
  municipality     String?
  municipalityName String?
  country          String     @default("ESP")
  birthDate        DateTime?
  nationality      String?
  sex              String?
  phone            String?
  phone2           String?
  email            String?
  role             String     @default("VI")
  kinship          String?
  incomeId         Int?
  sesReportId      Int?
  Income           Income?    @relation(fields: [incomeId], references: [id], onDelete: Cascade)
  SesReport        SesReport? @relation(fields: [sesReportId], references: [id])

  @@schema("casarural")
}

model Income {
  id            Int         @id @default(autoincrement())
  date          DateTime
  checkOut      DateTime?
  amount        Decimal
  description   String?
  propertyType  String      @default("BOTH")
  nights        Int         @default(1)
  invoiceNumber String?     @unique
  invoiceDate   DateTime?
  createdAt     DateTime    @default(now())
  Guest         Guest[]
  SesReport     SesReport[]

  @@schema("casarural")
}

model Leave {
  id          Int      @id @default(autoincrement())
  employeeId  Int
  type        String
  startDate   DateTime
  endDate     DateTime
  description String?
  status      String   @default("APPROVED")
  createdAt   DateTime @default(now())
  Employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@schema("casarural")
}

model Payslip {
  id           Int      @id @default(autoincrement())
  employeeId   Int
  month        Int
  year         Int
  grossAmount  Decimal
  netAmount    Decimal
  employerCost Decimal
  details      String?
  generatedAt  DateTime @default(now())
  Employee     Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@schema("casarural")
}

model SesConfig {
  id                      Int      @id @default(autoincrement())
  codigoArrendador        String
  codigoEstablecimiento   String
  nombreEstablecimiento   String
  tipoEstablecimiento     String   @default("VT")
  aplicacion              String   @default("CasaRuralWeb")
  sesUsername             String?
  sesPassword             String?
  direccion               String
  direccionComplementaria String?
  codigoPostal            String
  codigoMunicipio         String
  nombreMunicipio         String
  pais                    String   @default("ESP")
  isActive                Boolean  @default(true)
  updatedAt               DateTime

  @@schema("casarural")
}

model SesReport {
  id                 Int       @id @default(autoincrement())
  referencia         String    @unique
  fechaContrato      DateTime
  fechaEntrada       DateTime
  fechaSalida        DateTime
  numPersonas        Int
  numHabitaciones    Int?
  internet           Boolean   @default(true)
  tipoPago           String
  fechaPago          DateTime?
  medioPago          String?
  titularPago        String?
  caducidadTarjeta   String?
  status             String    @default("PENDING")
  codigoComunicacion String?
  codigoLote         String?
  lastError          String?
  sentAt             DateTime?
  incomeId           Int?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime
  Guest              Guest[]
  Income             Income?   @relation(fields: [incomeId], references: [id])

  @@schema("casarural")
}

model public_Expense {
  id          String          @id
  provider    String
  date        DateTime
  baseAmount  Float
  vatAmount   Float
  vatRate     Float
  totalAmount Float
  category    ExpenseCategory @default(OTROS)
  status      String          @default("PENDIENTE_DE_REVISION")
  rawText     String?
  pdfUrl      String?
  createdAt   DateTime        @default(now())

  @@map("Expense")
  @@schema("public")
}

enum Role {
  ADMIN
  OWNER
  TEACHER
  FAMILY
  GUEST
  CASA_RURAL
  EMPLEADO

  @@schema("public")
}

enum ExpenseCategory {
  LUZ
  AGUA
  INTERNET
  LAVANDERIA
  IBI
  OTROS

  @@schema("public")
}
